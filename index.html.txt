<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>天天背单词</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <style>
        /* --- 样式表 (CSS) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .header { background-color: #4A90E2; color: white; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        
        /* 卡片样式 */
        .card { background: white; border-radius: 12px; padding: 25px; width: 90%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        .word-text { font-size: 36px; color: #333; font-weight: bold; margin: 10px 0; }
        .meaning-text { font-size: 28px; color: #1565C0; font-weight: bold; margin: 10px 0; }
        .sub-text { color: #888; font-size: 16px; margin-bottom: 20px; }
        
        /* 按钮样式 */
        .btn { border: none; border-radius: 8px; padding: 12px 24px; font-size: 16px; margin: 5px; cursor: pointer; width: 100%; max-width: 300px; transition: 0.2s; }
        .btn-primary { background-color: #4A90E2; color: white; }
        .btn-success { background-color: #66BB6A; color: white; }
        .btn-danger { background-color: #EF5350; color: white; }
        .btn-outline { background-color: transparent; border: 1px solid #4A90E2; color: #4A90E2; }
        .btn:active { transform: scale(0.98); }

        /* 输入框 */
        input[type="text"] { width: 80%; padding: 12px; font-size: 18px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; text-align: center; }

        /* 隐藏/显示控制 */
        .hidden { display: none !important; }
        
        /* 底部导航 */
        .nav { background: white; border-top: 1px solid #eee; padding: 10px; display: flex; justify-content: space-around; width: 100%; position: fixed; bottom: 0; }
        .nav-item { color: #888; font-size: 14px; text-align: center; flex: 1; padding: 5px; cursor: pointer; }
        .nav-item.active { color: #4A90E2; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">天天背单词</div>

<div id="page-home" class="container">
    <div class="card">
        <h3>今日任务</h3>
        <div id="today-count" style="font-size: 60px; color: #4A90E2; font-weight: bold;">0</div>
        <p>个单词需要复习</p>
        <button class="btn btn-primary" onclick="startSession()">开始背诵</button>
    </div>
    
    <div style="width: 100%; max-width: 400px; text-align: left;">
        <h4>家长录入区</h4>
        <div id="word-list" style="background: white; border-radius: 8px; padding: 10px; height: 200px; overflow-y: scroll;">
            </div>
    </div>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="showAddModal()">+ 录入新词</button>
</div>

<div id="page-study" class="container hidden">
    <div id="phase-spell" class="card">
        <div class="sub-text">请根据中文写出英文</div>
        <div id="study-meaning" class="meaning-text">苹果</div>
        <div id="study-pos" class="sub-text">n.</div>
        <input type="text" id="input-spell" placeholder="在此输入英文" autocomplete="off">
        <div id="spell-msg" style="height: 20px; color: red; margin-bottom: 10px;"></div>
        <button class="btn btn-primary" onclick="checkSpelling()">确定</button>
    </div>

    <div id="phase-recall" class="card hidden">
        <div class="sub-text">大声说出中文意思</div>
        <div id="study-spelling-display" class="word-text">Apple</div>
        
        <div id="recall-cover">
            <button class="btn btn-outline" onclick="revealAnswer()">查看答案</button>
        </div>
        
        <div id="recall-answer" class="hidden">
            <div id="study-meaning-answer" class="meaning-text">苹果</div>
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="rateWord(1)">忘了 (重来)</button>
                <button class="btn btn-success" onclick="rateWord(5)">记得 (通过)</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-add" class="container hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 10;">
    <div class="card" style="margin-top: 50px;">
        <h3>录入新词</h3>
        <input type="text" id="new-spell" placeholder="英文 (如 apple)">
        <input type="text" id="new-pos" placeholder="词性 (如 n.)">
        <input type="text" id="new-meaning" placeholder="中文 (如 苹果)">
        <button class="btn btn-primary" onclick="saveNewWord()">保存</button>
        <button class="btn btn-outline" onclick="hideAddModal()">取消</button>
    </div>
</div>

<script>
    // --- 逻辑代码 (JavaScript) ---
    
    // 1. 数据结构与存储
    let words = JSON.parse(localStorage.getItem('tiantian_words')) || [];

    function saveToStorage() {
        localStorage.setItem('tiantian_words', JSON.stringify(words));
    }

    // 2. 核心算法 (SM-2 JS版)
    function updateMemory(word, quality) {
        if (quality >= 3) {
            if (word.repetitions === 0) word.interval = 1;
            else if (word.repetitions === 1) word.interval = 6;
            else word.interval = Math.ceil(word.interval * word.easeFactor);
            word.repetitions++;
        } else {
            word.repetitions = 0;
            word.interval = 1;
        }
        word.easeFactor = Math.max(1.3, word.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
        
        let nextDate = new Date();
        nextDate.setHours(0,0,0,0);
        nextDate.setDate(nextDate.getDate() + word.interval);
        word.nextReview = nextDate.getTime(); // 存时间戳方便比较
    }

    // 3. 界面逻辑
    let reviewList = [];
    let currentWord = null;

    function renderHome() {
        // 计算今日任务
        let now = new Date().setHours(0,0,0,0);
        let count = words.filter(w => w.nextReview <= now).length;
        document.getElementById('today-count').innerText = count;

        // 渲染列表
        let listHtml = words.map(w => 
            `<div style="border-bottom:1px solid #eee; padding:5px;">
                <b>${w.spelling}</b> - ${w.meaning} 
                <span style="font-size:12px; color:#999">(${new Date(w.nextReview).getMonth()+1}.${new Date(w.nextReview).getDate()})</span>
             </div>`
        ).join('');
        document.getElementById('word-list').innerHTML = listHtml || '<div style="color:#999; text-align:center;">暂无单词</div>';
    }

    function showAddModal() { document.getElementById('modal-add').classList.remove('hidden'); }
    function hideAddModal() { document.getElementById('modal-add').classList.add('hidden'); }

    function saveNewWord() {
        let s = document.getElementById('new-spell').value.trim();
        let p = document.getElementById('new-pos').value.trim();
        let m = document.getElementById('new-meaning').value.trim();
        if(!s || !m) return alert("请填写完整");
        
        words.push({
            spelling: s, pos: p, meaning: m,
            nextReview: new Date().setHours(0,0,0,0), // 今天
            interval: 1, easeFactor: 2.5, repetitions: 0
        });
        saveToStorage();
        document.getElementById('new-spell').value = '';
        document.getElementById('new-meaning').value = '';
        hideAddModal();
        renderHome();
    }

    // --- 背诵流程 ---
    function startSession() {
        let now = new Date().setHours(0,0,0,0);
        reviewList = words.filter(w => w.nextReview <= now);
        if(reviewList.length === 0) return alert("今天没有任务啦！");
        
        document.getElementById('page-home').classList.add('hidden');
        document.getElementById('page-study').classList.remove('hidden');
        loadNextCard();
    }

    function loadNextCard() {
        if(reviewList.length === 0) {
            alert("今日打卡完成！");
            location.reload();
            return;
        }
        currentWord = reviewList[0];
        
        // 重置界面
        document.getElementById('phase-spell').classList.remove('hidden');
        document.getElementById('phase-recall').classList.add('hidden');
        document.getElementById('recall-answer').classList.add('hidden');
        document.getElementById('recall-cover').classList.remove('hidden');
        document.getElementById('input-spell').value = '';
        document.getElementById('spell-msg').innerText = '';
        
        // 填充内容
        document.getElementById('study-meaning').innerText = currentWord.meaning;
        document.getElementById('study-pos').innerText = currentWord.pos;
        document.getElementById('study-spelling-display').innerText = currentWord.spelling;
        document.getElementById('study-meaning-answer').innerText = currentWord.meaning;
    }

    function checkSpelling() {
        let input = document.getElementById('input-spell').value.trim();
        if(input.toLowerCase() === currentWord.spelling.toLowerCase()) {
            // 拼对，进下一阶段
            document.getElementById('phase-spell').classList.add('hidden');
            document.getElementById('phase-recall').classList.remove('hidden');
        } else {
            // 拼错
            document.getElementById('spell-msg').innerText = "不对哦，正确是: " + currentWord.spelling;
            // 惩罚机制：拼错直接算忘
            updateMemory(currentWord, 0);
            saveToStorage();
        }
    }

    function revealAnswer() {
        document.getElementById('recall-cover').classList.add('hidden');
        document.getElementById('recall-answer').classList.remove('hidden');
    }

    function rateWord(score) {
        // 如果刚才拼写就错了，这里无论选什么，算法其实已经记过0分了。
        // 为了简单，我们只在最后更新一次状态。
        updateMemory(currentWord, score);
        saveToStorage();
        reviewList.shift(); // 移除当前
        loadNextCard();
    }

    // PWA Service Worker 注册
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    // 初始化
    renderHome();

</script>
</body>
</html>