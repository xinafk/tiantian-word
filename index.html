<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©å¤©èƒŒå•è¯ (ç»Ÿè®¡å¢å¼ºç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .header { background-color: #4A90E2; color: white; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        
        /* å¡ç‰‡é€šç”¨ */
        .card { background: white; border-radius: 12px; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        
        /* æ–‡å­—æ ·å¼ */
        .word-text { font-size: 36px; color: #333; font-weight: bold; margin: 10px 0; }
        .meaning-text { font-size: 28px; color: #1565C0; font-weight: bold; margin: 10px 0; }
        .sub-text { color: #888; font-size: 16px; margin-bottom: 20px; }
        .phase-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-bottom: 15px; font-weight: bold; }

        /* æŒ‰é’® */
        .btn { border: none; border-radius: 8px; padding: 12px 24px; font-size: 16px; margin: 5px; cursor: pointer; width: 100%; max-width: 300px; transition: 0.2s; }
        .btn-primary { background-color: #4A90E2; color: white; }
        .btn-success { background-color: #66BB6A; color: white; }
        .btn-danger { background-color: #EF5350; color: white; }
        .btn-outline { background-color: transparent; border: 1px solid #4A90E2; color: #4A90E2; }
        .btn:active { transform: scale(0.98); }

        /* è¾“å…¥æ¡† */
        input[type="text"] { width: 80%; padding: 12px; font-size: 18px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; text-align: center; }
        .input-group { width: 90%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }

        /* å·¥å…·ç±» */
        .hidden { display: none !important; }
        .flash-success { animation: flashGreen 1s; }
        @keyframes flashGreen { 0% { background-color: #e8f5e9; } 100% { background-color: white; } }
        
        /* ç»Ÿè®¡å›¾è¡¨æ ·å¼ */
        .stats-grid { display: flex; justify-content: space-around; width: 100%; margin-bottom: 20px; }
        .stat-item { text-align: center; }
        .stat-num { font-size: 24px; font-weight: bold; color: #333; }
        .stat-label { font-size: 12px; color: #999; }
        
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 150px; padding-top: 20px; border-bottom: 1px solid #eee; width: 100%; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .chart-bar { width: 12px; background-color: #e3f2fd; border-radius: 4px 4px 0 0; transition: height 0.5s; min-height: 4px; }
        .chart-bar.active { background-color: #4A90E2; }
        .chart-date { font-size: 10px; color: #999; margin-top: 5px; }
    </style>
</head>
<body>

<div class="header">å¤©å¤©èƒŒå•è¯</div>

<div id="page-home" class="container">
    <div class="card">
        <h3>ä»Šæ—¥ä»»åŠ¡</h3>
        <div id="today-count" style="font-size: 60px; color: #4A90E2; font-weight: bold;">0</div>
        <p>ä¸ªå•è¯éœ€è¦å¤ä¹ </p>
        <button class="btn btn-primary" onclick="startSession()">å¼€å§‹èƒŒè¯µ</button>
    </div>
    
    <div class="card" onclick="showStats()" style="cursor: pointer;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</span>
            <span style="color:#999;">æŸ¥çœ‹è¿›åº¦ ></span>
        </div>
    </div>
    
    <div style="width: 100%; max-width: 400px; text-align: left;">
        <h4>å®¶é•¿å½•å…¥åŒº</h4>
        <div id="word-list" style="background: white; border-radius: 8px; padding: 10px; height: 200px; overflow-y: scroll;"></div>
    </div>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="showAddModal()">+ å½•å…¥æ–°è¯</button>
</div>

<div id="page-study" class="container hidden">
    <div id="phase-spell" class="card hidden">
        <div class="phase-tag" style="background:#e3f2fd; color:#1565c0;">ç¬¬ 1 å…³ï¼šæ‹¼å†™æŒ‘æˆ˜</div>
        <div class="sub-text">è¯·æ ¹æ®ä¸­æ–‡å†™å‡ºè‹±æ–‡</div>
        <div id="spell-meaning" class="meaning-text"></div>
        <div id="spell-pos" class="sub-text"></div>
        <input type="text" id="input-spell" placeholder="è¾“å…¥è‹±æ–‡" autocomplete="off" onkeyup="if(event.keyCode===13) submitSpelling()">
        <div id="spell-msg" style="height: 20px; color: red; margin-bottom: 10px;"></div>
        <button class="btn btn-primary" onclick="submitSpelling()">ç¡®å®š</button>
    </div>

    <div id="phase-recall" class="card hidden">
        <div class="phase-tag" style="background:#fff3e0; color:#e65100;">ç¬¬ 2 å…³ï¼šå¼€å£è¯´</div>
        <div class="sub-text">è¯·å¤§å£°è¯´å‡ºä¸­æ–‡æ„æ€</div>
        <div id="recall-spelling" class="word-text"></div>
        
        <div id="recall-cover">
            <button class="btn btn-outline" onclick="revealAnswer()">æŸ¥çœ‹ç­”æ¡ˆ</button>
        </div>
        
        <div id="recall-answer" class="hidden">
            <div id="recall-meaning" class="meaning-text"></div>
            <div id="recall-pos" class="sub-text"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="rateWord(1)">å¿˜äº† (é‡æ¥)</button>
                <button class="btn btn-success" onclick="rateWord(5)">è®°å¾— (é€šè¿‡)</button>
            </div>
        </div>
    </div>
</div>

<div id="page-stats" class="container hidden">
    <div class="card">
        <h3>å­¦ä¹ æ•°æ®çœ‹æ¿</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-num" id="stat-total-words">0</div>
                <div class="stat-label">æ€»å•è¯</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="stat-days">0</div>
                <div class="stat-label">åšæŒå¤©æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="stat-mastered">0</div>
                <div class="stat-label">å·²æŒæ¡</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>è¿‘7å¤©å­¦ä¹ é‡</h3>
        <div class="chart-container" id="chart-week">
            </div>
    </div>

    <button class="btn btn-outline" onclick="goHome()">è¿”å›é¦–é¡µ</button>
</div>

<div id="modal-add" class="container hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 10;">
    <div class="card" style="margin-top: 50px;">
        <h3>æ™ºèƒ½å½•å…¥</h3>
        <div class="input-group">
            <input type="text" id="new-spell" placeholder="è¾“å…¥è‹±æ–‡ (å¦‚ book)" onblur="autoFill()" onkeyup="if(event.keyCode===13) autoFill()">
            <input type="text" id="new-pos" placeholder="è¯æ€§ (è‡ªåŠ¨ç”Ÿæˆ)">
            <input type="text" id="new-meaning" placeholder="ä¸­æ–‡ (è‡ªåŠ¨ç”Ÿæˆ)">
        </div>
        <button class="btn btn-primary" onclick="saveNewWord()">ä¿å­˜å¹¶ç»§ç»­</button>
        <button class="btn btn-outline" onclick="hideAddModal()">å…³é—­</button>
    </div>
</div>

<script>
    // --- 0. å†…ç½®å­—å…¸ (å¯è‡ªè¡Œæ‰©å……) ---
    const MINI_DICT = {
        "apple": ["n.", "è‹¹æœ"], "banana": ["n.", "é¦™è•‰"], "book": ["n.", "ä¹¦"], "cat": ["n.", "çŒ«"], 
        "dog": ["n.", "ç‹—"], "elephant": ["n.", "å¤§è±¡"], "run": ["v.", "è·‘"], "eat": ["v.", "åƒ"],
        "student": ["n.", "å­¦ç”Ÿ"], "teacher": ["n.", "è€å¸ˆ"], "good": ["adj.", "å¥½çš„"], "happy": ["adj.", "å¿«ä¹çš„"]
    };

    // --- 1. æ•°æ®ç®¡ç† ---
    let words = JSON.parse(localStorage.getItem('tiantian_words')) || [];
    let stats = JSON.parse(localStorage.getItem('tiantian_stats')) || {}; // æ ¼å¼: {"2023-10-01": 5}

    function saveToStorage() {
        localStorage.setItem('tiantian_words', JSON.stringify(words));
        localStorage.setItem('tiantian_stats', JSON.stringify(stats));
    }

    // è®°å½•ç»Ÿè®¡æ•°æ®
    function logActivity(count) {
        if(count <= 0) return;
        let today = new Date().toISOString().split('T')[0];
        stats[today] = (stats[today] || 0) + count;
        saveToStorage();
    }

    // --- 2. æ ¸å¿ƒç®—æ³• (SM-2) ---
    function updateMemory(word, quality) {
        // quality: 0=å¿˜/é”™, 5=å¯¹
        if (quality >= 3) {
            if (word.repetitions === 0) word.interval = 1;
            else if (word.repetitions === 1) word.interval = 6;
            else word.interval = Math.ceil(word.interval * word.easeFactor);
            word.repetitions++;
        } else {
            word.repetitions = 0;
            word.interval = 1;
        }
        word.easeFactor = Math.max(1.3, word.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
        
        let nextDate = new Date();
        nextDate.setHours(0,0,0,0);
        nextDate.setDate(nextDate.getDate() + word.interval);
        word.nextReview = nextDate.getTime();
    }

    // --- 3. é¡µé¢é€»è¾‘ ---
    // è¿è¡Œæ—¶å˜é‡
    let sessionWords = [];     // åŸå§‹éœ€è¦å¤ä¹ çš„åˆ—è¡¨
    let spellQueue = [];       // æ‹¼å†™é˜Ÿåˆ— (ä¹±åº)
    let recallQueue = [];      // å›å¿†é˜Ÿåˆ— (ä¹±åº)
    let errorSet = new Set();  // è®°å½•æ‹¼å†™é˜¶æ®µé”™çš„è¯ID

    // å·¥å…·: æ•°ç»„ä¹±åº
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // æ¸²æŸ“é¦–é¡µ
    function renderHome() {
        let now = new Date().setHours(0,0,0,0);
        let count = words.filter(w => w.nextReview <= now).length;
        document.getElementById('today-count').innerText = count;

        let listHtml = words.slice().reverse().map(w => 
            `<div style="border-bottom:1px solid #eee; padding:8px; display:flex; justify-content:space-between;">
                <span><b>${w.spelling}</b> <span style="font-size:12px;color:#888;">${w.pos}</span></span>
                <span>${w.meaning}</span>
             </div>`
        ).join('');
        document.getElementById('word-list').innerHTML = listHtml || '<div style="color:#999; text-align:center; padding:20px;">æš‚æ— å•è¯</div>';
    }

    // å¼€å§‹èƒŒè¯µ
    function startSession() {
        let now = new Date().setHours(0,0,0,0);
        sessionWords = words.filter(w => w.nextReview <= now);
        
        if(sessionWords.length === 0) return alert("å¤ªæ£’äº†ï¼ä»Šå¤©æ²¡æœ‰ä»»åŠ¡å•¦ï¼");

        // å‡†å¤‡é˜Ÿåˆ—
        errorSet.clear();
        // æµ…æ‹·è´å¹¶ä¹±åºï¼Œç”¨äºæ‹¼å†™é˜¶æ®µ
        spellQueue = shuffle([...sessionWords]); 
        // æµ…æ‹·è´å¹¶ä¹±åºï¼Œç”¨äºå›å¿†é˜¶æ®µ (ç¡®ä¿é¡ºåºä¸ä¸€æ ·)
        recallQueue = shuffle([...sessionWords]);

        document.getElementById('page-home').classList.add('hidden');
        document.getElementById('page-study').classList.remove('hidden');
        
        loadSpellCard();
    }

    // --- A. æ‹¼å†™é˜¶æ®µ ---
    let currentSpellWord = null;
    
    function loadSpellCard() {
        if (spellQueue.length === 0) {
            // æ‹¼å†™é˜¶æ®µç»“æŸï¼Œè¿›å…¥å›å¿†é˜¶æ®µ
            alert("ç¬¬ä¸€å…³æ‹¼å†™å®Œæˆï¼å‡†å¤‡è¿›å…¥ç¬¬äºŒå…³å›å¿†æµ‹è¯•ï¼");
            loadRecallCard();
            return;
        }
        currentSpellWord = spellQueue[0];
        document.getElementById('phase-spell').classList.remove('hidden');
        document.getElementById('phase-recall').classList.add('hidden');
        
        document.getElementById('spell-meaning').innerText = currentSpellWord.meaning;
        document.getElementById('spell-pos').innerText = currentSpellWord.pos;
        document.getElementById('input-spell').value = '';
        document.getElementById('spell-msg').innerText = '';
        document.getElementById('input-spell').focus();
    }

    function submitSpelling() {
        let input = document.getElementById('input-spell').value.trim();
        if (!input) return;

        if (input.toLowerCase() === currentSpellWord.spelling.toLowerCase()) {
            // æ‹¼å¯¹äº†
        } else {
            // æ‹¼é”™äº†
            alert(`âŒ é”™äº†ï¼æ­£ç¡®å†™æ³•æ˜¯ï¼š${currentSpellWord.spelling}`);
            errorSet.add(currentSpellWord); // è®°å…¥é»‘åå•
        }
        
        spellQueue.shift(); // ç§»å‡ºé˜Ÿåˆ—
        loadSpellCard();    // ä¸‹ä¸€ä¸ª
    }

    // --- B. å›å¿†é˜¶æ®µ ---
    let currentRecallWord = null;

    function loadRecallCard() {
        if (recallQueue.length === 0) {
            finishSession();
            return;
        }
        currentRecallWord = recallQueue[0];
        
        document.getElementById('phase-spell').classList.add('hidden');
        document.getElementById('phase-recall').classList.remove('hidden');
        document.getElementById('recall-cover').classList.remove('hidden');
        document.getElementById('recall-answer').classList.add('hidden');
        
        document.getElementById('recall-spelling').innerText = currentRecallWord.spelling;
        document.getElementById('recall-meaning').innerText = currentRecallWord.meaning;
        document.getElementById('recall-pos').innerText = currentRecallWord.pos;
    }

    function revealAnswer() {
        document.getElementById('recall-cover').classList.add('hidden');
        document.getElementById('recall-answer').classList.remove('hidden');
    }

    function rateWord(quality) {
        // æ ¸å¿ƒé€»è¾‘ï¼š
        // å¦‚æœæ‹¼å†™é˜¶æ®µ(errorSet)æœ‰å®ƒï¼Œè¯´æ˜æ‹¼é”™äº†ï¼Œå¼ºåˆ¶åˆ¤å®šä¸º 0 åˆ†
        // å¦‚æœå›å¿†é˜¶æ®µè‡ªå·±é€‰å¿˜äº†(quality=1)ï¼Œä¹Ÿæ˜¯ 0 åˆ†
        let finalQuality = quality;
        if (errorSet.has(currentRecallWord)) {
            finalQuality = 0; // æ‹¼å†™é”™ï¼Œç›´æ¥æ–©
        }

        updateMemory(currentRecallWord, finalQuality);
        
        recallQueue.shift();
        loadRecallCard();
    }

    function finishSession() {
        saveToStorage();
        // è®°å½•ç»Ÿè®¡ (ä»Šå¤©èƒŒäº† sessionWords.length ä¸ª)
        logActivity(sessionWords.length);
        
        alert("ğŸ‰ ä»Šå¤©çš„è®­ç»ƒå…¨éƒ¨å®Œæˆï¼è®°å¾—å»çœ‹çœ‹ç»Ÿè®¡æ•°æ®å“¦ï¼");
        goHome();
    }

    // --- 4. å½•å…¥ä¸è¾…åŠ© ---
    function showAddModal() { 
        document.getElementById('modal-add').classList.remove('hidden'); 
        document.getElementById('new-spell').focus();
    }
    function hideAddModal() { document.getElementById('modal-add').classList.add('hidden'); renderHome(); }
    
    function autoFill() {
        let w = document.getElementById('new-spell').value.toLowerCase().trim();
        if(MINI_DICT[w]) {
            document.getElementById('new-pos').value = MINI_DICT[w][0];
            document.getElementById('new-meaning').value = MINI_DICT[w][1];
            document.getElementById('new-pos').parentElement.classList.add('flash-success');
            setTimeout(()=>document.getElementById('new-pos').parentElement.classList.remove('flash-success'),500);
        }
    }

    function saveNewWord() {
        let s = document.getElementById('new-spell').value.trim();
        let p = document.getElementById('new-pos').value.trim();
        let m = document.getElementById('new-meaning').value.trim();
        if(!s || !m) return alert("å†…å®¹ä¸å®Œæ•´");
        
        if(words.find(w => w.spelling.toLowerCase()===s.toLowerCase())) return alert("å·²å­˜åœ¨");

        words.push({ spelling: s, pos: p, meaning: m, nextReview: new Date().setHours(0,0,0,0), interval: 1, easeFactor: 2.5, repetitions: 0 });
        saveToStorage();
        
        document.getElementById('new-spell').value = '';
        document.getElementById('new-pos').value = '';
        document.getElementById('new-meaning').value = '';
        document.getElementById('new-spell').focus();
    }

    function goHome() {
        document.getElementById('page-stats').classList.add('hidden');
        document.getElementById('page-study').classList.add('hidden');
        document.getElementById('page-home').classList.remove('hidden');
        renderHome();
    }

    // --- 5. ç»Ÿè®¡ç•Œé¢é€»è¾‘ ---
    function showStats() {
        document.getElementById('page-home').classList.add('hidden');
        document.getElementById('page-stats').classList.remove('hidden');
        
        // æ¸²æŸ“æ•°å­—
        document.getElementById('stat-total-words').innerText = words.length;
        document.getElementById('stat-days').innerText = Object.keys(stats).length;
        let mastered = words.filter(w => w.interval > 21).length; // é—´éš”å¤§äº21å¤©è§†ä¸ºæŒæ¡
        document.getElementById('stat-mastered').innerText = mastered;

        // æ¸²æŸ“å›¾è¡¨ (æœ€è¿‘7å¤©)
        let chartHtml = '';
        let today = new Date();
        let maxVal = 0;
        let dataPoints = [];

        // æ„é€ è¿‡å»7å¤©çš„æ•°æ®
        for(let i=6; i>=0; i--) {
            let d = new Date();
            d.setDate(today.getDate() - i);
            let dateStr = d.toISOString().split('T')[0];
            let val = stats[dateStr] || 0;
            if(val > maxVal) maxVal = val;
            dataPoints.push({ date: dateStr.slice(5), val: val }); // åªå– MM-DD
        }

        // é¿å…åˆ†æ¯ä¸º0
        if(maxVal === 0) maxVal = 10; 

        dataPoints.forEach(p => {
            let h = (p.val / maxVal) * 100; // ç™¾åˆ†æ¯”é«˜åº¦
            let colorClass = (p.date === today.toISOString().split('T')[0].slice(5)) ? 'active' : '';
            chartHtml += `
                <div class="chart-bar-group">
                    <div class="chart-bar ${colorClass}" style="height:${h}px;"></div>
                    <div class="chart-date">${p.date}</div>
                </div>
            `;
        });
        document.getElementById('chart-week').innerHTML = chartHtml;
    }

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    renderHome();

</script>
</body>
</html>
