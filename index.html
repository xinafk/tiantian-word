<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©å¤©èƒŒå•è¯ v2.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f4f8; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #4A90E2, #67B26F); color: white; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; z-index: 5; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }

        /* å¡ç‰‡ */
        .card { background: white; border-radius: 16px; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); text-align: center; margin-bottom: 20px; transition: transform 0.2s; }
        
        /* æ§ä»¶ */
        .btn { border: none; border-radius: 12px; padding: 14px 24px; font-size: 16px; margin: 8px; cursor: pointer; width: 100%; max-width: 300px; font-weight: bold; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-primary { background-color: #4A90E2; color: white; }
        .btn-success { background-color: #66BB6A; color: white; }
        .btn-danger { background-color: #EF5350; color: white; }
        .btn-outline { background-color: transparent; border: 2px solid #4A90E2; color: #4A90E2; box-shadow: none; }
        .btn-speak { background: #E1F5FE; color: #0277BD; width: auto; padding: 8px 16px; border-radius: 20px; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; }

        /* è¾“å…¥æ¡† */
        input[type="text"], textarea { width: 80%; padding: 14px; font-size: 20px; border: 2px solid #eee; border-radius: 12px; margin-bottom: 15px; text-align: center; outline: none; transition: border 0.3s; resize: none; font-family: inherit; }
        input[type="text"]:focus, textarea:focus { border-color: #4A90E2; }
        
        .input-group { width: 90%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }

        .hidden { display: none !important; }
        .flash-success { animation: flashGreen 0.5s; }
        @keyframes flashGreen { 0% { background-color: #e8f5e9; transform: scale(1.02); } 100% { background-color: white; transform: scale(1); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }
        
        .word-text { font-size: 40px; color: #333; font-weight: bold; margin: 10px 0; font-family: 'Arial Rounded MT Bold', sans-serif; cursor: pointer; }
        .meaning-text { font-size: 24px; color: #1565C0; font-weight: bold; margin: 10px 0; line-height: 1.4; word-wrap: break-word; } 
        .sub-text { color: #888; font-size: 16px; margin-bottom: 20px; }
        
        /* ç­‰çº§æ  */
        .level-bar-container { width: 100%; background: #eee; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .level-bar-fill { height: 100%; background: linear-gradient(90deg, #FF9800, #FF5722); width: 0%; transition: width 0.5s; }
        .level-badge { font-size: 14px; background: #FFF3E0; color: #E65100; padding: 5px 10px; border-radius: 15px; font-weight: bold; display: inline-block; margin-bottom: 5px; }
        
        /* å›¾è¡¨ */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 150px; padding-top: 20px; border-bottom: 1px solid #eee; width: 100%; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .chart-bar { width: 12px; background-color: #e3f2fd; border-radius: 4px 4px 0 0; transition: height 0.5s; min-height: 4px; }
        .chart-bar.active { background-color: #4A90E2; }
        .chart-date { font-size: 10px; color: #999; margin-top: 5px; }

        /* å½•å…¥æˆåŠŸæç¤ºæ¡ */
        #toast-msg { background: #66BB6A; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; margin-bottom: 10px; transition: opacity 0.5s; opacity: 0; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div class="header">å¤©å¤©èƒŒå•è¯ v2.1</div>

<div id="page-home" class="container">
    <div class="card" style="background: linear-gradient(to right, #ffffff, #f9f9f9);">
        <div id="level-title" class="level-badge">ğŸŒ± å•è¯èŒæ–° Lv.1</div>
        <div class="level-bar-container"><div id="level-fill" class="level-bar-fill"></div></div>
        <div style="font-size:12px; color:#888; display:flex; justify-content:space-between;">
            <span id="exp-current">0 XP</span><span id="exp-next">50 XP</span>
        </div>
    </div>
    <div class="card">
        <h3>ä»Šæ—¥ä»»åŠ¡</h3>
        <div id="today-count" style="font-size: 60px; color: #4A90E2; font-weight: bold;">0</div>
        <p>ä¸ªå•è¯éœ€è¦å¤ä¹ </p>
        <button class="btn btn-primary" onclick="startSession()">ğŸš€ å¼€å§‹èƒŒè¯µ</button>
    </div>
    <div class="card" onclick="showStats()" style="cursor: pointer;">
        <div style="display:flex; justify-content:space-between; align-items:center;"><span>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</span><span>></span></div>
    </div>
    <div style="width: 100%; max-width: 400px; text-align: left;">
        <h4>å®¶é•¿å½•å…¥åŒº</h4>
        <div id="word-list" style="background: white; border-radius: 8px; padding: 10px; height: 150px; overflow-y: scroll;"></div>
    </div>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="showAddModal()">+ æé€Ÿå½•å…¥</button>
</div>

<div id="page-study" class="container hidden">
    <div id="phase-learn" class="card hidden">
        <div class="phase-tag" style="background:#e8f5e9; color:#2e7d32;">ç¬¬ 1 æ­¥ï¼šé¢„ä¹ è®°å¿†</div>
        <div class="sub-text">è¯·çœ‹æ¸…å•è¯å¹¶è®°ä½å®ƒ</div>
        <div onclick="speakCurrentLearnWord()" class="word-text" id="learn-spelling"></div>
        <div id="learn-meaning" class="meaning-text"></div>
        <div id="learn-pos" class="sub-text"></div>
        <div class="btn-speak" onclick="speakCurrentLearnWord()">ğŸ”Š å¬å‘éŸ³</div>
        <div style="margin-top: 30px;">
            <button class="btn btn-success" onclick="nextLearnCard()">ğŸ‘Œ è®°ä½äº†ï¼Œä¸‹ä¸€ä¸ª</button>
        </div>
    </div>

    <div id="phase-spell" class="card hidden">
        <div class="phase-tag" style="background:#e3f2fd; color:#1565c0;">ç¬¬ 2 æ­¥ï¼šæ‹¼å†™é»˜å†™</div>
        <div class="sub-text">è¯·æ ¹æ®ä¸­æ–‡å†™å‡ºè‹±æ–‡</div>
        <div id="spell-meaning" class="meaning-text"></div>
        <div id="spell-pos" class="sub-text"></div>
        <input type="text" id="input-spell" placeholder="è¾“å…¥è‹±æ–‡" autocomplete="off" onkeyup="if(event.keyCode===13) submitSpelling()">
        <button class="btn btn-primary" onclick="submitSpelling()">âœ… ç¡®å®š</button>
        <button class="btn btn-danger" onclick="skipSpelling()">ğŸ˜­ ä¸ä¼š / è·³è¿‡</button>
    </div>

    <div id="phase-recall" class="card hidden">
        <div class="phase-tag" style="background:#fff3e0; color:#e65100;">ç¬¬ 3 æ­¥ï¼šå¼€å£è¯´</div>
        <div class="sub-text">è¯·å¤§å£°è¯´å‡ºä¸­æ–‡æ„æ€</div>
        <div onclick="speakCurrentWord()" class="word-text" id="recall-spelling"></div>
        <div class="btn-speak" onclick="speakCurrentWord()">ğŸ”Š ç‚¹æˆ‘å‘éŸ³</div>
        <div id="recall-cover" style="margin-top:20px;"><button class="btn btn-outline" onclick="revealAnswer()">ğŸ‘€ æŸ¥çœ‹ç­”æ¡ˆ</button></div>
        <div id="recall-answer" class="hidden" style="margin-top:20px;">
            <div id="recall-meaning" class="meaning-text"></div>
            <div id="recall-pos" class="sub-text"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="rateWord(1)">ğŸ˜­ å¿˜äº†</button>
                <button class="btn btn-success" onclick="rateWord(5)">ğŸ˜ è®°å¾—</button>
            </div>
        </div>
    </div>
</div>

<div id="page-stats" class="container hidden">
    <div class="card">
        <h3>å­¦ä¹ æ•°æ®çœ‹æ¿</h3>
        <div style="display:flex; justify-content:space-around;">
            <div><div class="stat-num" id="stat-total-words">0</div><div class="stat-label">æ€»è¯æ•°</div></div>
            <div><div class="stat-num" id="stat-days">0</div><div class="stat-label">åšæŒå¤©æ•°</div></div>
            <div><div class="stat-num" id="stat-mastered">0</div><div class="stat-label">å·²æŒæ¡</div></div>
        </div>
    </div>
    <div class="card"><h3>è¿‘7å¤©è¶‹åŠ¿</h3><div class="chart-container" id="chart-week"></div></div>
    <button class="btn btn-outline" onclick="goHome()">è¿”å›é¦–é¡µ</button>
</div>

<div id="modal-add" class="container hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 20;">
    <div class="card" style="margin-top: 50px;">
        <h3>æé€Ÿå½•å…¥</h3>
        <p style="font-size:12px; color:#666; margin-top:-5px;">è¾“å…¥è‹±æ–‡ï¼Œè‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€ç¡®è®¤</p>
        
        <div id="toast-msg"></div> <div class="input-group">
            <input type="text" id="new-spell" placeholder="è¾“å…¥å•è¯ (å¦‚ apple)" autocomplete="off" onkeyup="if(event.keyCode===13) processInput()">
            <div id="network-status" style="height:20px; font-size:12px; color:#666; margin-bottom:5px;"></div>
            
            <div id="manual-entry" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center; animation: shake 0.5s;">
                <p style="color:#d32f2f; font-size:14px; font-weight:bold;">âš ï¸ æ²¡æ‰¾åˆ°è¯¥è¯ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ä¸­æ–‡ï¼š</p>
                <input type="text" id="new-pos" placeholder="è¯æ€§ (å¦‚ n.)">
                <textarea id="new-meaning" rows="2" placeholder="ä¸­æ–‡æ„æ€"></textarea>
                <button class="btn btn-warning" onclick="saveManual()">ğŸ’¾ å¼ºåˆ¶ä¿å­˜</button>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; width:100%; justify-content:center;">
            <button class="btn btn-primary" onclick="processInput()">ä¸‹ä¸€ä¸ª (Enter)</button>
            <button class="btn btn-outline" onclick="hideAddModal()">ç»“æŸå½•å…¥</button>
        </div>
    </div>
</div>

<script>
    // --- 1. æé€Ÿå½•å…¥æ ¸å¿ƒé€»è¾‘ ---
    
    // ç”¨æˆ·ç‚¹â€œä¸‹ä¸€ä¸ªâ€æˆ–æŒ‰å›è½¦è§¦å‘
    function processInput() {
        let raw = document.getElementById('new-spell').value.trim();
        let status = document.getElementById('network-status');
        let manualDiv = document.getElementById('manual-entry');

        if(!raw) return;

        // æŸ¥é‡
        if(words.find(w => w.spelling.toLowerCase() === raw.toLowerCase())) {
            showToast(`âš ï¸ "${raw}" å·²ç»åœ¨åº“é‡Œäº†`);
            document.getElementById('new-spell').value = '';
            return;
        }

        // å°è¯•æ¿€æ´»éŸ³é¢‘(ä»¥é˜²å½•å®Œç›´æ¥èƒŒ)
        initAudio();

        status.innerText = "â˜ï¸ æ­£åœ¨æŸ¥è¯¢å¹¶ä¿å­˜...";
        
        // å‘èµ·è¯·æ±‚
        let script = document.createElement('script');
        script.src = `https://dict.youdao.com/suggest?q=${raw}&num=1&doctype=json&callback=handleFastSaveResponse&t=${new Date().getTime()}`;
        document.body.appendChild(script);
        
        // 4ç§’è¶…æ—¶å¤„ç†
        setTimeout(()=>{
            if(status.innerText.includes("æŸ¥è¯¢")) {
                status.innerText = "";
                manualDiv.classList.remove('hidden'); // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æ¡†
            }
        }, 4000);
    }

    // è‡ªåŠ¨ä¿å­˜å›è°ƒ
    window.handleFastSaveResponse = function(d) {
        let status = document.getElementById('network-status');
        let manualDiv = document.getElementById('manual-entry');
        let rawSpell = document.getElementById('new-spell').value.trim();

        if(d && d.entries && d.entries.length) {
            let explain = d.entries[0].explain; 
            let pos = "", mean = explain;
            
            let dotIndex = explain.indexOf('.');
            if (dotIndex > -1 && dotIndex < 10) {
                pos = explain.substring(0, dotIndex + 1); 
                mean = explain.substring(dotIndex + 1).trim();
            }
            
            // --- æ ¸å¿ƒï¼šç›´æ¥ä¿å­˜ï¼Œä¸æ˜¾ç¤ºè¯¦æƒ… ---
            saveWordInternal(d.entries[0].entry, pos, mean); // ä½¿ç”¨APIè¿”å›çš„entryç¡®ä¿å¤§å°å†™æ ‡å‡†ï¼Œæˆ–è€…ç”¨rawSpell
            
            // æˆåŠŸåé¦ˆ
            status.innerText = "";
            showToast(`âœ… å·²æ·»åŠ : ${d.entries[0].entry}`);
            
            // æ¸…ç©ºï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ª
            document.getElementById('new-spell').value = '';
            document.getElementById('new-spell').focus();
            manualDiv.classList.add('hidden'); // ç¡®ä¿æ‰‹åŠ¨æ¡†éšè—
            
        } else {
            // æ²¡æ‰¾åˆ°
            status.innerText = "";
            manualDiv.classList.remove('hidden'); // å¼¹å‡ºæ‰‹åŠ¨æ¡†
            document.getElementById('new-pos').focus();
        }
    };

    function saveManual() {
        let s = document.getElementById('new-spell').value.trim();
        let p = document.getElementById('new-pos').value.trim();
        let m = document.getElementById('new-meaning').value.trim();
        if(!s || !m) return alert("è¯·å¡«å†™ä¸­æ–‡æ„æ€");
        
        saveWordInternal(s, p, m);
        
        showToast(`ğŸ’¾ æ‰‹åŠ¨ä¿å­˜: ${s}`);
        
        // é‡ç½®ç•Œé¢
        document.getElementById('new-spell').value = '';
        document.getElementById('new-pos').value = '';
        document.getElementById('new-meaning').value = '';
        document.getElementById('manual-entry').classList.add('hidden');
        document.getElementById('new-spell').focus();
    }

    function saveWordInternal(s, p, m) {
        words.push({spelling:s, pos:p, meaning:m, nextReview:new Date().setHours(0,0,0,0), interval:1, easeFactor:2.5, repetitions:0});
        saveToStorage(); 
        updateLevel();
    }

    function showToast(msg) {
        let t = document.getElementById('toast-msg');
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

    // --- 2. éŸ³æ•ˆä¸æœ—è¯» ---
    let audioCtx = null;
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playSound(type) {
        initAudio();
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'correct') {
            osc.frequency.value = 800; osc.type = 'sine'; osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'wrong') {
            osc.frequency.value = 150; osc.type = 'sawtooth'; osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3);
            osc.stop(audioCtx.currentTime + 0.3);
        } else if (type === 'win') {
            osc.frequency.value = 600; osc.type = 'square'; osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            osc.stop(audioCtx.currentTime + 0.5);
        }
    }
    function speakText(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US'; u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }
    }

    // --- 3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---
    let words = JSON.parse(localStorage.getItem('tiantian_words')) || [];
    let stats = JSON.parse(localStorage.getItem('tiantian_stats')) || {};
    function saveToStorage() { localStorage.setItem('tiantian_words', JSON.stringify(words)); localStorage.setItem('tiantian_stats', JSON.stringify(stats)); }
    function updateLevel() {
        const t = words.length;
        let title="ğŸŒ± å•è¯èŒæ–°", p=0, n=50;
        if(t>=500){title="ğŸ‘‘ å•è¯ç‹è€…";p=500;n=1000;} else if(t>=200){title="âš”ï¸ è®°å¿†éª‘å£«";p=200;n=500;} else if(t>=50){title="ğŸƒâ€â™‚ï¸ å•è¯å­¦å¾’";p=50;n=200;}
        document.getElementById('level-title').innerText=`${title} (æ€»è¯æ•°:${t})`;
        document.getElementById('exp-current').innerText=t; document.getElementById('exp-next').innerText=n;
        document.getElementById('level-fill').style.width = `${Math.min(((t-p)/(n-p))*100, 100)}%`;
    }

    let sessionWords=[], learnQueue=[], spellQueue=[], recallQueue=[], errorSet=new Set();
    let currentLearnWord=null, currentSpellWord=null, currentRecallWord=null;

    function startSession() {
        initAudio();
        if('speechSynthesis' in window) window.speechSynthesis.cancel();

        let now = new Date().setHours(0,0,0,0);
        sessionWords = words.filter(w => w.nextReview <= now);
        if(sessionWords.length === 0) return alert("å¤ªæ£’äº†ï¼ä»Šå¤©æ²¡æœ‰ä»»åŠ¡å•¦ï¼");
        errorSet.clear();
        
        const shuffle = arr => arr.sort(() => Math.random() - 0.5);
        learnQueue = [...sessionWords]; 
        spellQueue = shuffle([...sessionWords]); 
        recallQueue = shuffle([...sessionWords]);
        
        document.getElementById('page-home').classList.add('hidden'); 
        document.getElementById('page-study').classList.remove('hidden');
        loadLearnCard();
    }

    // --- é¢„ä¹ å…³ ---
    function loadLearnCard() {
        if (learnQueue.length === 0) { 
            alert("ğŸ‘ é¢„ä¹ å®Œæˆï¼å‡†å¤‡å¼€å§‹æ‹¼å†™é»˜å†™ï¼"); 
            loadSpellCard(); 
            return; 
        }
        currentLearnWord = learnQueue[0];
        document.getElementById('phase-learn').classList.remove('hidden');
        document.getElementById('phase-spell').classList.add('hidden');
        document.getElementById('phase-recall').classList.add('hidden');
        document.getElementById('learn-spelling').innerText = currentLearnWord.spelling;
        document.getElementById('learn-meaning').innerText = currentLearnWord.meaning;
        document.getElementById('learn-pos').innerText = currentLearnWord.pos;
        speakText(currentLearnWord.spelling);
    }
    function nextLearnCard() { learnQueue.shift(); loadLearnCard(); }
    function speakCurrentLearnWord() { initAudio(); if(currentLearnWord) speakText(currentLearnWord.spelling); }

    // --- æ‹¼å†™å…³ ---
    function loadSpellCard() {
        if (spellQueue.length === 0) { alert("ğŸ‘ é»˜å†™å®Œæˆï¼è¿›å…¥å£è¯­å‘éŸ³å…³ï¼"); loadRecallCard(); return; }
        currentSpellWord = spellQueue[0];
        document.getElementById('phase-learn').classList.add('hidden');
        document.getElementById('phase-spell').classList.remove('hidden');
        document.getElementById('phase-recall').classList.add('hidden');
        document.getElementById('spell-meaning').innerText=currentSpellWord.meaning; 
        document.getElementById('spell-pos').innerText=currentSpellWord.pos;
        document.getElementById('input-spell').value=''; document.getElementById('input-spell').focus();
    }
    function submitSpelling() {
        let i = document.getElementById('input-spell').value.trim();
        initAudio(); if(!i) return;
        if(i.toLowerCase()===currentSpellWord.spelling.toLowerCase()){
            playSound('correct'); spellQueue.shift(); loadSpellCard();
        } else { handleSpellError(); }
    }
    function skipSpelling() { initAudio(); handleSpellError(); }
    function handleSpellError() {
        playSound('wrong'); 
        let c=document.getElementById('phase-spell'); c.classList.add('shake'); setTimeout(()=>c.classList.remove('shake'),500);
        alert(`âŒ æ­£ç¡®å†™æ³•æ˜¯ï¼š${currentSpellWord.spelling}`);
        errorSet.add(currentSpellWord); spellQueue.shift(); loadSpellCard();
    }

    // --- å›å¿†å…³ ---
    function loadRecallCard() {
        if (recallQueue.length === 0) { finishSession(); return; }
        currentRecallWord = recallQueue[0];
        document.getElementById('phase-learn').classList.add('hidden');
        document.getElementById('phase-spell').classList.add('hidden'); 
        document.getElementById('phase-recall').classList.remove('hidden');
        document.getElementById('recall-cover').classList.remove('hidden'); 
        document.getElementById('recall-answer').classList.add('hidden');
        document.getElementById('recall-spelling').innerText=currentRecallWord.spelling;
        speakText(currentRecallWord.spelling);
    }
    function speakCurrentWord(){ initAudio(); if(currentRecallWord) speakText(currentRecallWord.spelling); }
    function revealAnswer(){ document.getElementById('recall-cover').classList.add('hidden'); document.getElementById('recall-answer').classList.remove('hidden'); document.getElementById('recall-meaning').innerText=currentRecallWord.meaning; document.getElementById('recall-pos').innerText=currentRecallWord.pos; }
    function rateWord(q) {
        initAudio(); q===5?playSound('correct'):playSound('wrong');
        let fq=q; if(errorSet.has(currentRecallWord)) fq=0;
        let w=currentRecallWord;
        if(fq>=3){ if(w.repetitions===0)w.interval=1; else if(w.repetitions===1)w.interval=6; else w.interval=Math.ceil(w.interval*w.easeFactor); w.repetitions++; }
        else { w.repetitions=0; w.interval=1; }
        w.easeFactor = Math.max(1.3, w.easeFactor + (0.1 - (5 - fq) * (0.02 + (5 - fq) * 0.02)));
        let nextDate = new Date(); nextDate.setHours(0,0,0,0);
        nextDate.setDate(nextDate.getDate() + w.interval);
        w.nextReview = nextDate.getTime();
        recallQueue.shift(); loadRecallCard();
    }
    function finishSession() {
        saveToStorage();
        let today = new Date().toISOString().split('T')[0];
        stats[today] = (stats[today] || 0) + sessionWords.length;
        saveToStorage();
        playSound('win'); fireConfetti();
        setTimeout(() => { alert("ğŸ‰ ä»Šå¤©çš„è®­ç»ƒå…¨éƒ¨å®Œæˆï¼è·å¾—å¤§é‡ç»éªŒå€¼ï¼"); goHome(); }, 2000);
    }
    function fireConfetti() {
        const c=document.getElementById('confetti-canvas'), ctx=c.getContext('2d');
        c.width=window.innerWidth; c.height=window.innerHeight;
        let p=[], cols=['#f00','#0f0','#00f','#ff0','#0ff'];
        for(let i=0;i<100;i++)p.push({x:c.width/2,y:c.height/2,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,c:cols[Math.floor(Math.random()*cols.length)],l:100});
        function d(){
            ctx.clearRect(0,0,c.width,c.height); let a=false;
            p.forEach(e=>{if(e.l>0){a=true;e.x+=e.vx;e.y+=e.vy;e.l--;ctx.fillStyle=e.c;ctx.fillRect(e.x,e.y,5,5)}});
            if(a)requestAnimationFrame(d); else ctx.clearRect(0,0,c.width,c.height);
        } d();
    }
    function showAddModal() { document.getElementById('modal-add').classList.remove('hidden'); document.getElementById('new-spell').focus(); }
    function hideAddModal() { document.getElementById('modal-add').classList.add('hidden'); renderHome(); }
    function goHome() {
        document.getElementById('page-stats').classList.add('hidden'); document.getElementById('page-study').classList.add('hidden'); document.getElementById('page-home').classList.remove('hidden');
        renderHome();
    }
    function renderHome() {
        let count = words.filter(w => w.nextReview <= new Date().setHours(0,0,0,0)).length;
        document.getElementById('today-count').innerText = count;
        updateLevel();
        document.getElementById('word-list').innerHTML = words.slice().reverse().map(w=>`
            <div style="border-bottom:1px solid #eee; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                <span onclick="speakText('${w.spelling}')">ğŸ”Š <b>${w.spelling}</b></span>
                <span style="font-size:14px; color:#666; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:150px;">${w.meaning}</span>
            </div>`).join('');
    }
    function showStats() {
        document.getElementById('page-home').classList.add('hidden'); document.getElementById('page-stats').classList.remove('hidden');
        document.getElementById('stat-total-words').innerText = words.length;
        document.getElementById('stat-days').innerText = Object.keys(stats).length;
        document.getElementById('stat-mastered').innerText = words.filter(w=>w.interval>21).length;
        let html='', today=new Date(), max=0;
        for(let i=6; i>=0; i--) {
            let d=new Date(); d.setDate(today.getDate()-i); let k=d.toISOString().split('T')[0];
            let v=stats[k]||0; if(v>max) max=v;
            let h=(v/(max||10))*100;
            html+=`<div class="chart-bar-group"><div class="chart-bar ${i===0?'active':''}" style="height:${h}px"></div><div class="chart-date">${k.slice(5)}</div></div>`;
        }
        document.getElementById('chart-week').innerHTML=html;
    }
    
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    renderHome();
</script>
</body>
</html>
