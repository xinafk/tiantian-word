<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©å¤©èƒŒå•è¯ (å®Œç¾ä¿®å¤ç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f4f8; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #4A90E2, #67B26F); color: white; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; z-index: 5; }
        
        /* å…³é”®ä¿®å¤ï¼šçƒŸèŠ±å±‚ç½®äºåº•å±‚ï¼Œé˜²æ­¢æŒ¡ä½æŒ‰é’® */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }

        /* å¡ç‰‡ */
        .card { background: white; border-radius: 16px; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); text-align: center; margin-bottom: 20px; transition: transform 0.2s; }
        
        /* ç­‰çº§æ  */
        .level-bar-container { width: 100%; background: #eee; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .level-bar-fill { height: 100%; background: linear-gradient(90deg, #FF9800, #FF5722); width: 0%; transition: width 0.5s; }
        .level-badge { font-size: 14px; background: #FFF3E0; color: #E65100; padding: 5px 10px; border-radius: 15px; font-weight: bold; display: inline-block; margin-bottom: 5px; }

        /* æ–‡å­— */
        .word-text { font-size: 40px; color: #333; font-weight: bold; margin: 10px 0; font-family: 'Arial Rounded MT Bold', sans-serif; cursor: pointer; }
        .meaning-text { font-size: 28px; color: #1565C0; font-weight: bold; margin: 10px 0; }
        .sub-text { color: #888; font-size: 16px; margin-bottom: 20px; }
        .phase-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-bottom: 15px; font-weight: bold; }

        /* æŒ‰é’® */
        .btn { border: none; border-radius: 12px; padding: 14px 24px; font-size: 16px; margin: 8px; cursor: pointer; width: 100%; max-width: 300px; transition: 0.1s; font-weight: bold; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-primary { background-color: #4A90E2; color: white; }
        .btn-success { background-color: #66BB6A; color: white; }
        .btn-danger { background-color: #EF5350; color: white; }
        .btn-outline { background-color: transparent; border: 2px solid #4A90E2; color: #4A90E2; box-shadow: none; }
        .btn-speak { background: #E1F5FE; color: #0277BD; width: auto; padding: 8px 16px; border-radius: 20px; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; }

        /* è¾“å…¥æ¡† */
        input[type="text"] { width: 80%; padding: 14px; font-size: 20px; border: 2px solid #eee; border-radius: 12px; margin-bottom: 15px; text-align: center; outline: none; transition: border 0.3s; }
        input[type="text"]:focus { border-color: #4A90E2; }
        .input-group { width: 90%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }

        /* åŠ¨ç”»ä¸ç‰¹æ•ˆ */
        .hidden { display: none !important; }
        .flash-success { animation: flashGreen 0.5s; }
        @keyframes flashGreen { 0% { background-color: #e8f5e9; transform: scale(1.02); } 100% { background-color: white; transform: scale(1); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }

        /* ç»Ÿè®¡å›¾è¡¨ */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 150px; padding-top: 20px; border-bottom: 1px solid #eee; width: 100%; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .chart-bar { width: 12px; background-color: #e3f2fd; border-radius: 4px 4px 0 0; transition: height 0.5s; min-height: 4px; }
        .chart-bar.active { background-color: #4A90E2; }
        .chart-date { font-size: 10px; color: #999; margin-top: 5px; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div class="header">å¤©å¤©èƒŒå•è¯</div>

<div id="page-home" class="container">
    <div class="card" style="background: linear-gradient(to right, #ffffff, #f9f9f9);">
        <div id="level-title" class="level-badge">ğŸŒ± å•è¯èŒæ–° Lv.1</div>
        <div class="level-bar-container">
            <div id="level-fill" class="level-bar-fill"></div>
        </div>
        <div style="font-size:12px; color:#888; display:flex; justify-content:space-between;">
            <span id="exp-current">0 XP</span>
            <span id="exp-next">50 XP</span>
        </div>
    </div>

    <div class="card">
        <h3>ä»Šæ—¥ä»»åŠ¡</h3>
        <div id="today-count" style="font-size: 60px; color: #4A90E2; font-weight: bold;">0</div>
        <p>ä¸ªå•è¯éœ€è¦å¤ä¹ </p>
        <button class="btn btn-primary" onclick="startSession()">ğŸš€ å¼€å§‹èƒŒè¯µ</button>
    </div>
    
    <div class="card" onclick="showStats()" style="cursor: pointer;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</span>
            <span>></span>
        </div>
    </div>
    
    <div style="width: 100%; max-width: 400px; text-align: left;">
        <h4>å®¶é•¿å½•å…¥åŒº</h4>
        <div id="word-list" style="background: white; border-radius: 8px; padding: 10px; height: 150px; overflow-y: scroll;"></div>
    </div>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="showAddModal()">+ å½•å…¥æ–°è¯</button>
</div>

<div id="page-study" class="container hidden">
    <div id="phase-spell" class="card hidden">
        <div class="phase-tag" style="background:#e3f2fd; color:#1565c0;">ç¬¬ 1 å…³ï¼šæ‹¼å†™æŒ‘æˆ˜</div>
        <div class="sub-text">è¯·æ ¹æ®ä¸­æ–‡å†™å‡ºè‹±æ–‡</div>
        <div id="spell-meaning" class="meaning-text"></div>
        <div id="spell-pos" class="sub-text"></div>
        <input type="text" id="input-spell" placeholder="è¾“å…¥è‹±æ–‡" autocomplete="off" onkeyup="if(event.keyCode===13) submitSpelling()">
        <button class="btn btn-primary" onclick="submitSpelling()">ç¡®å®š</button>
    </div>

    <div id="phase-recall" class="card hidden">
        <div class="phase-tag" style="background:#fff3e0; color:#e65100;">ç¬¬ 2 å…³ï¼šå¼€å£è¯´</div>
        <div class="sub-text">è¯·å¤§å£°è¯´å‡ºä¸­æ–‡æ„æ€</div>
        
        <div onclick="speakCurrentWord()" class="word-text" id="recall-spelling"></div>
        <div class="btn-speak" onclick="speakCurrentWord()">ğŸ”Š ç‚¹æˆ‘å‘éŸ³</div>
        
        <div id="recall-cover" style="margin-top:20px;">
            <button class="btn btn-outline" onclick="revealAnswer()">ğŸ‘€ æŸ¥çœ‹ç­”æ¡ˆ</button>
        </div>
        
        <div id="recall-answer" class="hidden" style="margin-top:20px;">
            <div id="recall-meaning" class="meaning-text"></div>
            <div id="recall-pos" class="sub-text"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="rateWord(1)">ğŸ˜­ å¿˜äº†</button>
                <button class="btn btn-success" onclick="rateWord(5)">ğŸ˜ è®°å¾—</button>
            </div>
        </div>
    </div>
</div>

<div id="page-stats" class="container hidden">
    <div class="card">
        <h3>å­¦ä¹ æ•°æ®çœ‹æ¿</h3>
        <div style="display:flex; justify-content:space-around;">
            <div><div class="stat-num" id="stat-total-words">0</div><div class="stat-label">æ€»è¯æ•°</div></div>
            <div><div class="stat-num" id="stat-days">0</div><div class="stat-label">åšæŒå¤©æ•°</div></div>
            <div><div class="stat-num" id="stat-mastered">0</div><div class="stat-label">å·²æŒæ¡</div></div>
        </div>
    </div>
    <div class="card">
        <h3>è¿‘7å¤©è¶‹åŠ¿</h3>
        <div class="chart-container" id="chart-week"></div>
    </div>
    <button class="btn btn-outline" onclick="goHome()">è¿”å›é¦–é¡µ</button>
</div>

<div id="modal-add" class="container hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 20;">
    <div class="card" style="margin-top: 50px;">
        <h3>æ™ºèƒ½å½•å…¥</h3>
        <div class="input-group">
            <input type="text" id="new-spell" placeholder="è‹±æ–‡ (å¦‚ apple)" onblur="fetchOnlineWord()" onkeyup="if(event.keyCode===13) fetchOnlineWord()">
            <div id="network-status" style="height:20px; font-size:12px; color:#666; margin-bottom:5px;"></div>
            <input type="text" id="new-pos" placeholder="è¯æ€§ (è‡ªåŠ¨)">
            <input type="text" id="new-meaning" placeholder="ä¸­æ–‡ (è‡ªåŠ¨)">
        </div>
        <button class="btn btn-primary" onclick="saveNewWord()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn btn-outline" onclick="hideAddModal()">âŒ å…³é—­</button>
    </div>
</div>

<script>
    // --- å…³é”®ä¿®å¤ï¼šå»¶è¿Ÿåˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢æ‰‹æœºæ‹¦æˆª ---
    let audioCtx = null; 

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playTone(freq, type, duration) {
        initAudio(); // æ¯æ¬¡æ’­æ”¾å‰å°è¯•æ¿€æ´»
        if (!audioCtx) return;
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    function playSound(type) {
        try {
            if (type === 'correct') {
                playTone(800, 'sine', 0.1);
                setTimeout(() => playTone(1200, 'sine', 0.3), 100);
            } else if (type === 'wrong') {
                playTone(150, 'sawtooth', 0.4);
            } else if (type === 'win') {
                playTone(400, 'square', 0.1);
                setTimeout(() => playTone(600, 'square', 0.1), 100);
                setTimeout(() => playTone(800, 'square', 0.4), 200);
            }
        } catch(e) { console.log('Audio blocked', e); }
    }

    function speakText(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }
    }

    // --- æ•°æ®ä¸é€»è¾‘ ---
    let words = JSON.parse(localStorage.getItem('tiantian_words')) || [];
    let stats = JSON.parse(localStorage.getItem('tiantian_stats')) || {};

    function saveToStorage() {
        localStorage.setItem('tiantian_words', JSON.stringify(words));
        localStorage.setItem('tiantian_stats', JSON.stringify(stats));
    }

    function updateLevel() {
        const totalWords = words.length;
        let title = "ğŸŒ± å•è¯èŒæ–°";
        let nextTarget = 50;
        let prevTarget = 0;
        
        if (totalWords >= 500) { title = "ğŸ‘‘ å•è¯ç‹è€…"; prevTarget=500; nextTarget=1000; }
        else if (totalWords >= 200) { title = "âš”ï¸ è®°å¿†éª‘å£«"; prevTarget=200; nextTarget=500; }
        else if (totalWords >= 50) { title = "ğŸƒâ€â™‚ï¸ å•è¯å­¦å¾’"; prevTarget=50; nextTarget=200; }

        document.getElementById('level-title').innerText = `${title} (æ€»è¯æ•°:${totalWords})`;
        document.getElementById('exp-current').innerText = `${totalWords}`;
        document.getElementById('exp-next').innerText = `${nextTarget}`;
        
        let percent = ((totalWords - prevTarget) / (nextTarget - prevTarget)) * 100;
        if(percent > 100) percent = 100;
        document.getElementById('level-fill').style.width = `${percent}%`;
    }

    // --- æ ¸å¿ƒæµç¨‹ ---
    let sessionWords = [], spellQueue = [], recallQueue = [], errorSet = new Set();
    let currentSpellWord = null, currentRecallWord = null;

    function startSession() {
        // ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œæ¿€æ´»éŸ³é¢‘ç¯å¢ƒ
        initAudio();
        
        let now = new Date().setHours(0,0,0,0);
        sessionWords = words.filter(w => w.nextReview <= now);
        if(sessionWords.length === 0) return alert("å¤ªæ£’äº†ï¼ä»Šå¤©æ²¡æœ‰ä»»åŠ¡å•¦ï¼");
        errorSet.clear();
        
        const shuffle = arr => arr.sort(() => Math.random() - 0.5);
        spellQueue = shuffle([...sessionWords]);
        recallQueue = shuffle([...sessionWords]);
        
        document.getElementById('page-home').classList.add('hidden');
        document.getElementById('page-study').classList.remove('hidden');
        loadSpellCard();
    }

    function loadSpellCard() {
        if (spellQueue.length === 0) { 
            alert("ğŸ‘ ç¬¬ä¸€å…³å®Œæˆï¼è¿›å…¥å£è¯­å‘éŸ³å…³ï¼"); 
            loadRecallCard(); 
            return; 
        }
        currentSpellWord = spellQueue[0];
        document.getElementById('phase-spell').classList.remove('hidden');
        document.getElementById('phase-recall').classList.add('hidden');
        document.getElementById('spell-meaning').innerText = currentSpellWord.meaning;
        document.getElementById('spell-pos').innerText = currentSpellWord.pos;
        document.getElementById('input-spell').value = '';
        document.getElementById('input-spell').focus();
    }

    function submitSpelling() {
        let input = document.getElementById('input-spell').value.trim();
        if(!input) return;
        
        // æ¯æ¬¡ç‚¹å‡»ä¹Ÿå°è¯•æ¿€æ´»éŸ³é¢‘
        initAudio();

        if (input.toLowerCase() === currentSpellWord.spelling.toLowerCase()) {
            playSound('correct');
            spellQueue.shift();
            loadSpellCard();
        } else {
            playSound('wrong');
            document.getElementById('phase-spell').classList.add('shake');
            setTimeout(() => document.getElementById('phase-spell').classList.remove('shake'), 500);
            alert(`âŒ é”™äº†ï¼æ­£ç¡®å†™æ³•æ˜¯ï¼š${currentSpellWord.spelling}`);
            errorSet.add(currentSpellWord);
            spellQueue.shift();
            loadSpellCard();
        }
    }

    function loadRecallCard() {
        if (recallQueue.length === 0) { finishSession(); return; }
        currentRecallWord = recallQueue[0];
        
        document.getElementById('phase-spell').classList.add('hidden');
        document.getElementById('phase-recall').classList.remove('hidden');
        document.getElementById('recall-cover').classList.remove('hidden');
        document.getElementById('recall-answer').classList.add('hidden');
        document.getElementById('recall-spelling').innerText = currentRecallWord.spelling;
        
        speakText(currentRecallWord.spelling);
    }
    
    function speakCurrentWord() {
        initAudio();
        if(currentRecallWord) speakText(currentRecallWord.spelling);
    }

    function revealAnswer() {
        document.getElementById('recall-cover').classList.add('hidden');
        document.getElementById('recall-answer').classList.remove('hidden');
        document.getElementById('recall-meaning').innerText = currentRecallWord.meaning;
        document.getElementById('recall-pos').innerText = currentRecallWord.pos;
    }

    function rateWord(quality) {
        initAudio();
        if(quality === 5) playSound('correct');
        else playSound('wrong');

        let finalQuality = quality;
        if (errorSet.has(currentRecallWord)) finalQuality = 0;
        
        let w = currentRecallWord;
        if (finalQuality >= 3) {
            if (w.repetitions === 0) w.interval = 1;
            else if (w.repetitions === 1) w.interval = 6;
            else w.interval = Math.ceil(w.interval * w.easeFactor);
            w.repetitions++;
        } else {
            w.repetitions = 0; w.interval = 1;
        }
        w.easeFactor = Math.max(1.3, w.easeFactor + (0.1 - (5 - finalQuality) * (0.1)));
        let nextDate = new Date(); nextDate.setHours(0,0,0,0);
        nextDate.setDate(nextDate.getDate() + w.interval);
        w.nextReview = nextDate.getTime();

        recallQueue.shift();
        loadRecallCard();
    }

    function finishSession() {
        saveToStorage();
        let today = new Date().toISOString().split('T')[0];
        stats[today] = (stats[today] || 0) + sessionWords.length;
        saveToStorage();
        
        playSound('win');
        fireConfetti();
        
        setTimeout(() => {
            alert("ğŸ‰ ä»Šå¤©çš„è®­ç»ƒå…¨éƒ¨å®Œæˆï¼è·å¾—å¤§é‡ç»éªŒå€¼ï¼");
            goHome();
        }, 2000);
    }

    // --- çƒŸèŠ± (Z-Index ä¿®å¤ç‰ˆ) ---
    function fireConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particles = [];
        const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
        
        for(let i=0; i<100; i++) {
            particles.push({
                x: canvas.width/2, y: canvas.height/2,
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                color: colors[Math.floor(Math.random()*colors.length)],
                life: 100
            });
        }
        
        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            let active = false;
            particles.forEach(p => {
                if(p.life > 0) {
                    active = true;
                    p.x += p.vx; p.y += p.vy; p.life--;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 5, 5);
                }
            });
            if(active) requestAnimationFrame(draw);
            else ctx.clearRect(0,0,canvas.width,canvas.height);
        }
        draw();
    }

    // --- è”ç½‘æŸ¥è¯ & é¡µé¢è·³è½¬ ---
    function fetchOnlineWord() {
        let w = document.getElementById('new-spell').value.trim();
        if(!w) return;
        document.getElementById('network-status').innerText = "ğŸ” æ­£åœ¨è”ç½‘...";
        let s = document.createElement('script');
        s.src = `https://dict.youdao.com/suggest?q=${w}&num=1&doctype=json&callback=handleYoudaoResponse`;
        document.body.appendChild(s);
    }
    window.handleYoudaoResponse = function(d) {
        let status = document.getElementById('network-status');
        if(d && d.entries && d.entries.length){
            let e = d.entries[0].explain;
            let m = e.match(/^([a-z]+\.)\s*(.+)$/);
            if(m) { document.getElementById('new-pos').value=m[1]; document.getElementById('new-meaning').value=m[2].split('ï¼›')[0]; }
            else { document.getElementById('new-pos').value=""; document.getElementById('new-meaning').value=e; }
            status.innerText = "âœ… è·å–æˆåŠŸ";
        } else { status.innerText = "âŒ æ²¡æ‰¾åˆ°ï¼Œè¯·æ‰‹å¡«"; }
    };
    function saveNewWord() {
        initAudio(); // å°è¯•æ¿€æ´»éŸ³é¢‘
        let s=document.getElementById('new-spell').value.trim(), p=document.getElementById('new-pos').value, m=document.getElementById('new-meaning').value;
        if(!s||!m) return alert("ä¸å®Œæ•´");
        if(words.find(w=>w.spelling.toLowerCase()===s.toLowerCase())) return alert("å·²å­˜åœ¨");
        words.push({spelling:s, pos:p, meaning:m, nextReview:new Date().setHours(0,0,0,0), interval:1, easeFactor:2.5, repetitions:0});
        saveToStorage(); updateLevel();
        document.getElementById('new-spell').value=''; document.getElementById('new-pos').value=''; document.getElementById('new-meaning').value='';
        document.getElementById('new-spell').focus();
    }
    function showAddModal() { document.getElementById('modal-add').classList.remove('hidden'); document.getElementById('new-spell').focus(); }
    function hideAddModal() { document.getElementById('modal-add').classList.add('hidden'); renderHome(); }
    function goHome() {
        document.getElementById('page-stats').classList.add('hidden'); document.getElementById('page-study').classList.add('hidden'); document.getElementById('page-home').classList.remove('hidden');
        renderHome();
    }
    function renderHome() {
        let count = words.filter(w => w.nextReview <= new Date().setHours(0,0,0,0)).length;
        document.getElementById('today-count').innerText = count;
        updateLevel();
        document.getElementById('word-list').innerHTML = words.slice().reverse().map(w=>`
            <div style="border-bottom:1px solid #eee; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                <span onclick="speakText('${w.spelling}')">ğŸ”Š <b>${w.spelling}</b></span>
                <span style="font-size:14px; color:#666;">${w.meaning}</span>
            </div>`).join('');
    }
    function showStats() {
        document.getElementById('page-home').classList.add('hidden'); document.getElementById('page-stats').classList.remove('hidden');
        document.getElementById('stat-total-words').innerText = words.length;
        document.getElementById('stat-days').innerText = Object.keys(stats).length;
        document.getElementById('stat-mastered').innerText = words.filter(w=>w.interval>21).length;
        let html='', today=new Date(), max=0;
        for(let i=6; i>=0; i--) {
            let d=new Date(); d.setDate(today.getDate()-i); let k=d.toISOString().split('T')[0];
            let v=stats[k]||0; if(v>max) max=v;
            let h=(v/(max||10))*100;
            html+=`<div class="chart-bar-group"><div class="chart-bar ${i===0?'active':''}" style="height:${h}px"></div><div class="chart-date">${k.slice(5)}</div></div>`;
        }
        document.getElementById('chart-week').innerHTML=html;
    }
    
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    renderHome();
</script>
</body>
</html>
